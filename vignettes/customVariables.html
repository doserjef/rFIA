<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Hunter Stanke, Jeffrey W. Doser" />


<title>Estimating Custom Variables</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Estimating Custom Variables</h1>
<h4 class="author">Hunter Stanke, Jeffrey W. Doser</h4>
<h4 class="date">2019 (last updated February 6, 2025)</h4>


<div id="TOC">
<ul>
<li><a href="#getting-started" id="toc-getting-started">Getting
started</a></li>
<li><a href="#grouping-variables" id="toc-grouping-variables">Grouping
variables</a>
<ul>
<li><a href="#examples" id="toc-examples">Examples</a></li>
</ul></li>
<li><a href="#tree-tree-ratios" id="toc-tree-tree-ratios">Tree-tree
ratios</a></li>
<li><a href="#area-area-ratios" id="toc-area-area-ratios">Area-area
ratios</a></li>
</ul>
</div>

<p>The <code>customPSE()</code> function is designed to produce
estimates of population totals, ratios, and associated variances for
custom variables using FIA’s post-stratified estimation procedures. It
is intended to be used in combination with standard rFIA estimator
functions, like <code>tpa()</code>, <code>area()</code>, and
<code>volume()</code>, among others.</p>
<p>In short, standard <code>rFIA</code> estimator functions can generate
tree- and or condition-lists for standard variables of interest (see
<code>treeList</code> and <code>condList</code> arguments in estimator
functions). Users may then make modifications to these standard
variables, for example a variable representing tree crown area may be
added to a tree-list produced by <code>tpa()</code> (via some suite of
allometrics). Users may then hand their modified tree-list to
<code>customPSE()</code> to estimate the total and proportion of
forested land area in their domain of interest that is covered by tree
crowns.</p>
<p>Three general forms of ratio estimates may be produced: tree-tree,
tree-area, and area-area ratios. Tree-area ratios are likely the most
familiar, such as trees per acre, tree biomass per acre, etc, where a
tree variable is specified as the numerator, and proportion of plot area
occupied by forestland is the denominator. Hence we’ll start with a
tree-area example below, and circle back to examples of tree-tree and
area-area ratios later on.</p>
<div id="getting-started" class="section level1">
<h1>Getting started</h1>
<p>Users can generate tree/ condition lists using most rFIA estimator
functions by setting the argument <code>treeList = TRUE</code> or
<code>condList = TRUE</code>, where the <code>treeList</code> argument
is available in functions that handle tree-level variables (e.g.,
<code>biomass()</code>, <code>growMort()</code>) and
<code>condList</code> is available in functions that handle
condition-level variables (all estimator functions not listed
previously).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(rFIA)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co"># Use volume to generate a tree list associated with the most recent volume</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co"># inventory in Rhode Island</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>tree.list <span class="ot">&lt;-</span> fiaRI <span class="sc">%&gt;%</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">clipFIA</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="fu">volume</span>(<span class="at">grpBy =</span> <span class="fu">c</span>(DIA, SPCD),</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>         <span class="at">treeList =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">head</span>(tree.list)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 14
##    PLT_CN EVAL_TYP TREE_BASIS AREA_BASIS pltID      DIA  SPCD CONDID  SUBP  TREE
##     &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1 2.47e14 VOL      MICR       SUBP       1_44_7_…   1.9   372      1     1     2
## 2 2.47e14 VOL      MICR       SUBP       1_44_7_…   3.6   746      1     1     1
## 3 2.47e14 VOL      MICR       SUBP       1_44_7_…   3.1   379      1     1     3
## 4 2.47e14 VOL      MICR       SUBP       1_44_7_…   2.7   379      1     1     4
## 5 2.47e14 VOL      MICR       SUBP       1_44_7_…   4.3   372      1     1     5
## 6 2.47e14 VOL      MICR       SUBP       1_44_7_…   3.2   379      1     1     6
## # ℹ 4 more variables: BOLE_CF_ACRE &lt;dbl&gt;, SAW_CF_ACRE &lt;dbl&gt;,
## #   SAW_MBF_ACRE &lt;dbl&gt;, PROP_FOREST &lt;dbl&gt;</code></pre>
<p>Note that the output above is similar to what you might expect from
an <code>rFIA</code> function when <code>byPlot = TRUE</code>, with the
key differences being (1) we’ve returned a tree/condition list as
opposed to a plot list, and (2) the inclusion of <code>EVAL_TYP</code>,
<code>TREE_BASIS</code> and <code>AREA_BASIS</code> variables. Here,
<code>TREE_BASIS</code> and <code>AREA_BASIS</code> indicate the primary
sampling unit for each tree and condition, respectively (e.g.,
microplot, subplot, or macroplot). This information is required to
“adjust” for non-response using FIA’s existing estimation approach. Note
also the inclusion of <code>PROP_FOREST</code> - indicating the areal
extent of the condition upon which each tree is growing, expressed as a
proportion of the plot area. As multiple trees generally grow on the
same condition, <code>PROP_FOREST</code> will be repeated in the tree
list.</p>
<p>Our tree/condition lists can then be modified to include custom,
derivative variables. For example, if we have stumpage data we can join
these data to our tree list, and compute the per-acre value of the
merchantable volume in each stem. We’ll generate some bogus pricing data
here for demonstration purposes:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Compute per-acre value of each tree (fake stumpage data)</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>tree.list <span class="ot">&lt;-</span> tree.list <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="co"># SAW_MBF_ACRE is the sawlog volume (thousand board feet) represented</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="co"># by each tree in the tree list, on a per acre basis. Here we generate</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="co"># random pricing data for each tree, and multiply it by volume/acre to </span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="co"># generate an index of value/acre for each tree</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VALUE_ACRE =</span> <span class="fu">case_when</span>(DIA <span class="sc">&lt;</span> <span class="dv">16</span> <span class="sc">~</span> SAW_MBF_ACRE <span class="sc">*</span> <span class="dv">250</span>,</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> SAW_MBF_ACRE <span class="sc">*</span> <span class="dv">1000</span>))</span></code></pre></div>
<p>We can now hand our tree/ condition list to <code>customPSE()</code>
to produce population estimates for our variables of interest. In this
case, let’s estimate mean sawlog volume and associated value per
forested acre (ratio estimates, where forested land area is
denominator).</p>
<p>We’ll need to split our merged tree/condition list produced with
<code>volume()</code> above into separate tree and condition lists,
where our tree list contains only tree-level variables (e.g.,
<code>SAW_MBF_ACRE</code>, <code>VALUE_ACRE</code>), and our
condition-list contains only condition-level variables
(<code>PROP_FOREST</code>). Inclusion of <code>TREE_BASIS</code> or
<code>AREA_BASIS</code> in each list will indicate whether variables are
measured at the tree- or condition-level. In addition, tree-lists must
retain <code>PLT_CN</code>, <code>SUBP</code>, and <code>TREE</code> to
ensure trees can be uniquely identified. Similarly, condition-lists must
retain <code>PLT_CN</code> and <code>CONDID</code> to ensure conditions
can be uniquely identified.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Produce ratio estimates of sawtimber volume / forested area</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>pop.est <span class="ot">&lt;-</span> fiaRI <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">clipFIA</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="fu">customPSE</span>(</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="co"># Tree list containing numerator variable(s), </span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="co"># plus TREE_BASIS, PLT_CN, SUBP, and TREE</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">select</span>(tree.list, <span class="sc">-</span><span class="fu">c</span>(AREA_BASIS, PROP_FOREST)),</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    <span class="co"># Variables in tree-list to be treated as numerator variables.</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    <span class="co"># Names will propagate through to output, so renaming may be </span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    <span class="co"># desired (as done here)</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="at">xVars =</span> <span class="fu">c</span>(<span class="at">SAW_MBF =</span> SAW_MBF_ACRE,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>              <span class="at">VALUE =</span> VALUE_ACRE),</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    <span class="co"># Grouping variables associated with numerator variable(s)</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="co"># None here, but examples include species, size class, etc.</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    <span class="at">xGrpBy =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    </span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>    <span class="co"># Condition list containing denominator variable</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">select</span>(tree.list, <span class="fu">c</span>(PLT_CN, CONDID, AREA_BASIS, PROP_FOREST)),</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>    </span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>    <span class="co"># Variable in condition-list to be treated as denominator</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>    <span class="co"># Again renaming using named vector</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>    <span class="at">yVars =</span> <span class="fu">c</span>(<span class="at">FOREST_AREA =</span> PROP_FOREST),</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>    <span class="co"># Grouping variables associated with denominator variable</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>    <span class="co"># Again, none here but retaining for transparency    </span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>    <span class="at">yGrpBy =</span> <span class="cn">NULL</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  )</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a><span class="fu">head</span>(pop.est)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 14
##    YEAR SAW_MBF_RATIO VALUE_RATIO SAW_MBF_TOTAL VALUE_TOTAL FOREST_AREA_TOTAL
##   &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;             &lt;dbl&gt;
## 1  2018          7.63       5435.      2800748. 1994471542.           366959.
## # ℹ 8 more variables: SAW_MBF_RATIO_VAR &lt;dbl&gt;, VALUE_RATIO_VAR &lt;dbl&gt;,
## #   SAW_MBF_TOTAL_VAR &lt;dbl&gt;, VALUE_TOTAL_VAR &lt;dbl&gt;,
## #   FOREST_AREA_TOTAL_VAR &lt;dbl&gt;, nPlots_x &lt;int&gt;, nPlots_y &lt;int&gt;, N &lt;int&gt;</code></pre>
<p>In the above, variables ending in <code>_RATIO</code> are our ratio
estimates — sawlog volume and associate value per forested acre.
Similarly, the suffixes <code>_TOTAL</code> and <code>_VAR</code>
indicate population totals and variances.</p>
<p>Only one of <code>TREE_BASIS</code> or <code>AREA_BASIS</code> may be
present <code>x</code> or <code>y</code>, as the presence of these
columns are used to determine if variables to be estimated are tree
variables or area variables. Some standard <code>rFIA</code> estimator
functions will produce tree-lists with both <code>TREE_BASIS</code> and
<code>AREA_BASIS</code> listed in output, as the tree-list will contain
tree variables (e.g., <code>TPA</code>, <code>BAA</code>) as well as
area variables (e.g., <code>PROP_FOREST</code>, proportion of plot
represented by the forested condition where each tree is growing). To
produce a tree-area ratio with such an output, <code>AREA_BASIS</code>
must be removed from the data.frame specified in <code>x</code>, and
<code>TREE_BASIS</code> must be removed from that specified in
<code>y</code>.</p>
</div>
<div id="grouping-variables" class="section level1">
<h1>Grouping variables</h1>
<p>In addition to handling custom state variables,
<code>customPSE()</code> also offers distinct flexibility in defining
populations of interest for numerator and denominator variables,
relative to standard rFIA estimator functions.</p>
<p>For example, <code>tpa()</code> estimates tree abundance (number and
basal area) on a per forested acre basis. If we specify a tree-level
variable in <code>grpBy</code> (e.g., species, size class), we’ll get
abundance estimates for each unique population defined by the variable.
However, area estimates (the denominator of our ratios) will ignore
tree-level grouping variables (only <code>areaDomain</code> and
condition/plot-level grouping variables are respected). So for example,
if species is listed as a grouping variable, <code>tpa</code> will
estimate the abundance of red oak relative to the full forested landbase
in our region of interest, as opposed to the abundance of red oak on the
portion of the forestland where red oak is present.</p>
<p><code>customPSE()</code> allows explicit specification of grouping
variables used to define populations of interest, and allows these
population definitions to vary between numerator and denominator
variables (via the <code>xGrpBy</code> and <code>yGrpBy</code>
arguments). The only requirement is that grouping variables specified
for the denominator MUST also be specified for the numerator. For
example, the following specifications are valid:</p>
<ul>
<li><em>Group numerator estimates by species, and denominator estimates
by species</em></li>
<li><em>Group numerator estimates by species, and do not group
denominator estimates</em></li>
</ul>
<p>But the following is invalid:</p>
<ul>
<li><em>Do not group numerator estimates, and group denominator
estimates by species</em></li>
</ul>
<div id="examples" class="section level3">
<h3>Examples</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Generate our tree list, grouping by species</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>tree.list <span class="ot">&lt;-</span> <span class="fu">tpa</span>(fiaRI,</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>                 <span class="at">bySpecies =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>                 <span class="at">treeList =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co"># Estimate abundance by species, relative to the full forested landbase</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co"># This is consistent with the behavior of `tpa()`</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>standard <span class="ot">&lt;-</span> fiaRI <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>  <span class="fu">customPSE</span>(</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    <span class="co"># Drop AREA_BASIS so function knows numerator is composed of </span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    <span class="co"># tree-level variables</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">select</span>(tree.list, <span class="sc">-</span><span class="fu">c</span>(AREA_BASIS)),</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    <span class="at">xVars =</span> <span class="fu">c</span>(TPA, BAA),</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="co"># Group numerator by species</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    <span class="at">xGrpBy =</span> <span class="fu">c</span>(COMMON_NAME, SPCD),</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="co"># Drop TREE_BASIS so function knows denominator is a</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    <span class="co"># condition-level variable</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">select</span>(tree.list, <span class="sc">-</span><span class="fu">c</span>(TREE_BASIS)),</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    <span class="at">yVars =</span> <span class="fu">c</span>(PROP_FOREST),</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    <span class="co"># Don&#39;t group denominator (full forested landbase)</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    <span class="at">yGrpBy =</span> <span class="cn">NULL</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>  )</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="co"># Estimate abundance by species, relative to the proportion of forested </span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="co"># landbase where each species is currently growing</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="co"># This is inconsistent with the behavior of `tpa()`</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>non.standard <span class="ot">&lt;-</span> fiaRI <span class="sc">%&gt;%</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>  <span class="fu">customPSE</span>(</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>    <span class="co"># Drop AREA_BASIS so function knows numerator is composed of </span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    <span class="co"># tree-level variables</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">select</span>(tree.list, <span class="sc">-</span><span class="fu">c</span>(AREA_BASIS)),</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>    <span class="at">xVars =</span> <span class="fu">c</span>(TPA, BAA),</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>    <span class="co"># Group numerator by species</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>    <span class="at">xGrpBy =</span> <span class="fu">c</span>(COMMON_NAME, SPCD),</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>    </span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>    <span class="co"># Drop TREE_BASIS so function knows denominator is a</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>    <span class="co"># condition-level variable</span></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">select</span>(tree.list, <span class="sc">-</span><span class="fu">c</span>(TREE_BASIS)),</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>    <span class="at">yVars =</span> <span class="fu">c</span>(PROP_FOREST),</span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>    <span class="co"># Also group numerator by species</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>    <span class="at">yGrpBy =</span>  <span class="fu">c</span>(COMMON_NAME, SPCD),</span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="tree-tree-ratios" class="section level1">
<h1>Tree-tree ratios</h1>
<p>Tree-tree ratios are useful for estimating “average tree” attributes,
e.g., mean tree height, biomass, wood density. Here we’ll estimate the
average height of canopy trees by species.</p>
<p>Our numerator will be the product of tree height and TPA, and our
denominator will be TPA alone. Multiplying height by TPA will account
for differences in sampling area for trees of various sizes, or weight
trees according to their implied relative abundance (implied by which of
micro-, sub-, or macro-plot they were sampled on). Note also how we
select canopy trees using <code>treeDomain</code> below:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Generate our tree list, grouping by species</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>tree.list <span class="ot">&lt;-</span> <span class="fu">tpa</span>(fiaRI,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>                 <span class="at">grpBy =</span> <span class="fu">c</span>(HT), <span class="co"># Height from the tree table (ft)</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>                 <span class="at">treeDomain =</span> CCLCD <span class="sc">%in%</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="co"># Dominant, co-dominant stems</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>                 <span class="at">bySpecies =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>                 <span class="at">treeList =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co"># Now we&#39;ll adjust tree height (HT) by TPA</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>tree.list<span class="sc">$</span>HT <span class="ot">&lt;-</span> tree.list<span class="sc">$</span>HT <span class="sc">*</span> tree.list<span class="sc">$</span>TPA</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co"># Estimate mean tree height by species</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>mean.ht <span class="ot">&lt;-</span>  fiaRI <span class="sc">%&gt;%</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  <span class="fu">clipFIA</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="fu">customPSE</span>(</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>    <span class="co"># Drop AREA_BASIS so function knows numerator is composed of </span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    <span class="co"># tree-level variables</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">select</span>(tree.list, <span class="sc">-</span><span class="fu">c</span>(AREA_BASIS)),</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>    <span class="at">xVars =</span> <span class="fu">c</span>(HT),</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>    <span class="co"># Group numerator by species</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>    <span class="at">xGrpBy =</span> <span class="fu">c</span>(COMMON_NAME, SPCD),</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>    </span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>    <span class="co"># Drop TREE_BASIS so function knows denominator is also a</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>    <span class="co"># tree-level variable</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>    <span class="at">y =</span>  <span class="fu">select</span>(tree.list, <span class="sc">-</span><span class="fu">c</span>(AREA_BASIS)),</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>    <span class="at">yVars =</span> <span class="fu">c</span>(TPA),</span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>    <span class="co"># Aslo group numerator by species</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>    <span class="at">yGrpBy =</span>  <span class="fu">c</span>(COMMON_NAME, SPCD),</span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  )</span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a><span class="fu">head</span>(mean.ht)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 12
##    YEAR COMMON_NAME   SPCD HT_RATIO HT_TOTAL TPA_TOTAL HT_RATIO_VAR HT_TOTAL_VAR
##   &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1  2018 American be…   531     63.0   1.16e7   183502.         9.50      2.50e13
## 2  2018 Atlantic wh…    43     51.6   2.23e6    43218.        16.8       2.41e12
## 3  2018 apple spp.     660     24     6.13e5    25528.         0         3.20e11
## 4  2018 bigtooth as…   743     69.6   2.03e7   291685.        16.6       5.70e13
## 5  2018 black cherry   762     39.1   3.80e7   970742.        15.4       4.74e14
## 6  2018 black locust   901     67     1.58e6    23624.         0         2.26e12
## # ℹ 4 more variables: TPA_TOTAL_VAR &lt;dbl&gt;, nPlots_x &lt;int&gt;, nPlots_y &lt;int&gt;,
## #   N &lt;int&gt;</code></pre>
</div>
<div id="area-area-ratios" class="section level1">
<h1>Area-area ratios</h1>
<p>Area-area ratios are useful for estimating “average stand”
attributes, e.g., mean stand age, mean slope, or disturbance rates (% of
forested landbase recently disturbed). Here we’ll estimate the average
stand age by ownership group.</p>
<p>Our numerator will be the product of stand age and
<code>PROP_FOREST</code> (proportion of plot area represented by each
forested condition), and our denominator will be
<code>PROP_FOREST</code> alone (summed by <code>customPSE()</code> to
yield proportionate plot area within our domain of interest).
Multiplying stand age by <code>PROP_FOREST</code> will account for
differences in the observed relative abundance of each condition, i.e.,
conditions occupying “slivers” of plots will be weighted less than
conditions occupying an entire plot.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Generate our condition list</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>cond.list <span class="ot">&lt;-</span> <span class="fu">area</span>(fiaRI,</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>                  <span class="at">grpBy =</span> <span class="fu">c</span>(STDAGE, OWNGRPCD), <span class="co"># Stand age from the cond table</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                  <span class="at">condList =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co"># Now we&#39;ll adjust stand age (STDAGE) by condition size</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>cond.list<span class="sc">$</span>STDAGE <span class="ot">&lt;-</span> cond.list<span class="sc">$</span>STDAGE <span class="sc">*</span> cond.list<span class="sc">$</span>PROP_FOREST</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co"># Estimate average stand age by ownership group</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>mean.age <span class="ot">&lt;-</span> fiaRI <span class="sc">%&gt;%</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="fu">clipFIA</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  <span class="fu">customPSE</span>(</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>    <span class="co"># Our condition list</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>    <span class="at">x =</span> cond.list,</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    <span class="at">xVars =</span> <span class="fu">c</span>(STDAGE),</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    <span class="at">xGrpBy =</span> <span class="fu">c</span>(OWNGRPCD),</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>    </span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>    <span class="co"># Same condition list as above</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    <span class="at">y =</span> cond.list,</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    <span class="at">yVars =</span> <span class="fu">c</span>(PROP_FOREST),</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    <span class="co"># Aslo group numerator by species</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>    <span class="at">yGrpBy =</span>  <span class="fu">c</span>(OWNGRPCD)</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>  )</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="fu">head</span>(mean.age)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 11
##    YEAR OWNGRPCD STDAGE_RATIO STDAGE_TOTAL PROP_FOREST_TOTAL STDAGE_RATIO_VAR
##   &lt;dbl&gt;    &lt;int&gt;        &lt;dbl&gt;        &lt;dbl&gt;             &lt;dbl&gt;            &lt;dbl&gt;
## 1  2018       30         73.3     8179573.           111642.            10.8 
## 2  2018       40         73.6    18789855.           255317.             2.99
## # ℹ 5 more variables: STDAGE_TOTAL_VAR &lt;dbl&gt;, PROP_FOREST_TOTAL_VAR &lt;dbl&gt;,
## #   nPlots_x &lt;int&gt;, nPlots_y &lt;int&gt;, N &lt;int&gt;</code></pre>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
